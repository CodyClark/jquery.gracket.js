// jquery.gracket.js
// Erik M. Zettersten
// https://github.com/erik5388/jquery.gracket.js
// MIT
// Version 1.5.5


(function(g){g.fn.gracket=function(p){g.fn.gracket.defaults={gracketClass:"g_gracket",gameClass:"g_game",roundClass:"g_round",roundLabelClass:"g_round_label",teamClass:"g_team",winnerClass:"g_winner",spacerClass:"g_spacer",currentClass:"g_current",cornerRadius:15,canvasId:"g_canvas",canvasClass:"g_canvas",canvasLineColor:"#eee",canvasLineCap:"round",canvasLineWidth:2,canvasLineGap:15,roundLabels:[],src:[]};var i=this,j="undefined"===typeof i.data("gracket")?[]:JSON.parse(i.data("gracket")),q,x,y,
t=[];g.fn.gracket.settings={};var z={init:function(a){this.gracket.settings=g.extend({},this.gracket.defaults,a);this.gracket.settings.src.length&&(j=this.gracket.settings.src);this.gracket.settings.canvasId=this.gracket.settings.canvasId+"_"+(new Date).getTime();a=document.createElement("canvas");a.id=this.gracket.settings.canvasId;a.className=this.gracket.settings.canvasClass;a.style.position="absolute";a.style.left=0;a.style.top=0;a.style.right="auto";i.addClass(this.gracket.settings.gracketClass).prepend(a);
x=j.length;for(a=0;a<x;a++){var d=l.build.round(this.gracket.settings);i.append(d);y=j[a].length;for(var b=0;b<y;b++){var c=l.build.game(this.gracket.settings),f=i.find("."+this.gracket.settings.gameClass).outerHeight(!0),f=l.build.spacer(this.gracket.settings,f,a,0!==a&&0===b?!0:!1);0==b%1&&0!==a&&d.append(f);d.append(c);q=j[a][b].length;for(f=0;f<q;f++){var h=l.build.team(j[a][b][f],this.gracket.settings);c.append(h);h=h.outerWidth(!0);if(void 0===t[a]||t[a]<h)t[a]=h;1===q&&(c.prev().remove(),l.align.winner(c,
this.gracket.settings,c.parent().prev().children().eq(0).height()),l.listeners(this.gracket.settings,j,c.parent().prev().children().eq(1)))}}}}},l={build:{team:function(a,d){return team=g("<div />",{html:"<h3><span>"+(a.seed||0)+"</span> "+a.name+"</h3>","class":d.teamClass+" "+(a.id||"id_null")})},game:function(a){return game=g("<div />",{"class":a.gameClass})},round:function(a){return round=g("<div />",{"class":a.roundClass})},spacer:function(a,d,b,c){return spacer=g("<div />",{"class":a.spacerClass}).css({height:c?
(Math.pow(2,b)-1)*(d/2):(Math.pow(2,b)-1)*d})},labels:function(a,d){var b,c=a.length,f,h=0;for(b=0;b<c;b++)f=0===b?d.padding+h:d.padding+h+d.right*b,g("<h5 />",{text:d.labels.length?d.labels[b]:"Round "+(b+1),"class":d["class"]}).css({position:"absolute",left:f,width:d.width}).prependTo(i),h+=t[b]},canvas:{resize:function(a){a=document.getElementById(a.canvasId);a.height=i.innerHeight();a.width=i.innerWidth();g(a).css({height:i.innerHeight(),width:i.innerWidth(),zIndex:1,pointerEvents:"none"})},draw:function(a,
d,b){var c=document.getElementById(a.canvasId);"undefined"!=typeof G_vmlCanvasManager&&G_vmlCanvasManager.initElement(c);var c=c.getContext("2d"),f=t[0],h=b.outerHeight(!0),j=parseInt(i.css("paddingLeft"))||0,p=parseInt(i.css("paddingTop"))||0;parseInt(b.css("marginBottom"));var q=f+j,r=parseInt(i.find("> div").css("marginRight"))||0,e=a.cornerRadius,u=a.canvasLineGap,z=b.height()-2*b.find("> div").eq(1).height();_playerHt=b.find("> div").eq(1).height();_totalItemWidth=0;"undefined"!==typeof console&&
console.info("Padding Left: "+j+"px","Player/Name Width: "+f+"px","Container padding left: "+q+"px");e>h/3&&(e=h/3);e>r/2&&(e=r/2-2);0>=e&&(e=1);u>r/3&&(u=r/3);c.strokeStyle=a.canvasLineColor;c.lineCap=a.canvasLineCap;c.lineWidth=a.canvasLineWidth;c.beginPath();var b=Math.pow(2,d.length-2),m=0,A,x=0.5,B=0===m&&1===b?!0:!1;if(B)var C=g("."+a.gameClass),f=C.eq(C.length-1),h=f.outerHeight(!0),f=f.outerWidth(!0);for(;1<=b;){for(A=0;A<b;A++){1==b&&(x=1);var n=B?f+j:q+_totalItemWidth+m*r,v=x*r,k=((Math.pow(2,
m-1)-0.5)*(m&&1)+A*Math.pow(2,m))*h+p+(B?C.find("> div").eq(1).height():_playerHt)+z/2;1<b?(c.moveTo(n+u,k),c.lineTo(n+v-e,k)):(c.moveTo(n+u,k),c.lineTo(n+3*u,k));if(1<b&&0==A%2){var y=k+e,D=k+Math.pow(2,m)*h-e;c.moveTo(n+v,y);c.lineTo(n+v,D);var w=n+v-e,s=k+e;c.moveTo(w,s-e);c.arcTo(w+e,s-e,w+e,s,e);s=k+Math.pow(2,m)*h-e;c.moveTo(w+e,s-e);c.arcTo(w+e,s+e,w,s+e,e);k=(y+D)/2;c.moveTo(n+v,k);c.lineTo(n+v+u,k)}}m++;f=t[m];_totalItemWidth+=f;b/=2}c.stroke();l.build.labels(d,{padding:j,left:q,right:r,
labels:a.roundLabels,"class":a.roundLabelClass})}}},align:{winner:function(a,d,b){b=1===a.parent().siblings().not("canvas").length?b-(a.height()+a.height()/2):b+a.height()/2;return a.addClass(d.winnerClass).css({"margin-top":b})}},listeners:function(a,d,b){g.each(g("."+a.teamClass+" > h3"),function(){var b="."+g(this).parent().attr("class").split(" ")[1];void 0!==b&&g(b).hover(function(){g(b).addClass(a.currentClass)},function(){g(b).removeClass(a.currentClass)})});l.build.canvas.resize(a);l.build.canvas.draw(a,
d,b)}};if(z[p])return z[p].apply(this,Array.prototype.slice.call(arguments,1));if("object"===typeof p||!p)return z.init.apply(this,arguments);g.error('Method "'+p+'" does not exist in gracket!')}})(jQuery);
