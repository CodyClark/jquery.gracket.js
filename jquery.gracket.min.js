// Bracket Plugin | Gracket (jquery.gracket.js)
// Erik Zettersten
// Version 1.8

(function(d){d.fn.gracket=function(k){d.fn.gracket.defaults={gameClass:"g_game",roundClass:"g_round",teamClass:"g_team",winnerClass:"g_winner",spacerClass:"g_spacer",currentClass:"g_current",cornerRadius:25,canvasId:"g_canvas",canvasClass:"g_canvas",canvasLineColor:"white",canvasLineWidth:2,canvasLineGap:5,canvasLineCap:"round",src:null};var h=this,o=JSON.parse(h.data("gracket"))||JSON.parse(this.gracket.defaults.src),q,u,v;d.fn.gracket.settings={};var t={init:function(a){this.gracket.settings=d.extend({}, this.gracket.defaults,a);h.append("<canvas id='"+this.gracket.settings.canvasId+'\' style="position:absolute;top:0;left:0;" />');u=o.length;for(a=0;a<u;a++){var m=g.build.round(this.gracket.settings);h.append(m);v=o[a].length;for(var e=0;e<v;e++){var b=g.build.game(this.gracket.settings),j=h.find("."+this.gracket.settings.gameClass).outerHeight(!0),j=g.build.spacer(this.gracket.settings,j,a,a!==0&&e===0?!0:!1);e%1==0&&a!==0&&m.append(j);m.append(b);q=o[a][e].length;for(j=0;j<q;j++){var w=g.build.team(o[a][e][j], this.gracket.settings);b.append(w);q===1&&(b.prev().remove(),g.align.winner(b,this.gracket.settings,b.parent().prev().children().eq(0).height()),g.listeners(this.gracket.settings,o,b.parent().prev().children().eq(1)))}}}}},g={build:{team:function(a,m){return team=d("<div />",{html:"<h3><span>"+(a.seed||0)+"</span>"+a.name+"</h3>","class":m.teamClass+" "+(a.id||"id_null")})},game:function(a){return game=d("<div />",{"class":a.gameClass})},round:function(a){return round=d("<div />",{"class":a.roundClass})}, spacer:function(a,m,e,b){return spacer=d("<div />",{"class":a.spacerClass}).css({height:b?(Math.pow(2,e)-1)*(m/2):(Math.pow(2,e)-1)*m})},canvas:{resize:function(a){a=document.getElementById(a.canvasId);a.height=h.innerHeight();a.width=h.innerWidth();d(a).css({height:h.innerHeight(),width:h.innerWidth(),zIndex:1,pointerEvents:"none"})},draw:function(a,d,e){var b=document.getElementById(a.canvasId).getContext("2d"),j=e.outerWidth(!0),g=e.outerHeight(!0),k=parseInt(h.css("paddingLeft"))||0,o=parseInt(h.css("paddingTop"))|| 0;parseInt(e.css("marginBottom"));var k=j+k,p=parseInt(h.find("> div").css("marginRight"))||0,c=a.cornerRadius,s=a.canvasLineGap,e=e.find("> div").eq(1).height();c>g/3&&(c=g/3);c>p/2&&(c=p/2-2);c<=0&&(c=1);s>p/3&&(s=p/3);b.strokeStyle=a.canvasLineColor;b.lineCap=a.canvasLineCap;b.lineWidth=a.canvasLineWidth;b.beginPath();for(var a=Math.pow(2,d.length-2),n=0,r,q=0.5;a>=1;){for(r=0;r<a;r++){a==1&&(q=1);var f=k+n*j+n*p,i=q*p,l=((Math.pow(2,n-1)-0.5)*(n&&1)+r*Math.pow(2,n))*g+o+e;b.moveTo(f+s,l);a>1? b.lineTo(f+i-c,l):b.lineTo(f+i,l);a<Math.pow(2,d.length-2)&&(b.moveTo(f-j-s,l),b.lineTo(f-j-0.5*p,l));a>1&&r%2==0&&(b.moveTo(f+i,l+c),b.lineTo(f+i,l+Math.pow(2,n)*g-c),f=f+i-c,i=l+c,b.moveTo(f,i-c),b.arcTo(f+c,i-c,f+c,i,c),i=l+Math.pow(2,n)*g-c,b.moveTo(f+c,i-c),b.arcTo(f+c,i+c,f,i+c,c))}n++;a/=2}b.stroke()}}},align:{winner:function(a,d,e){return a.addClass(d.winnerClass).css({"margin-top":e+a.height()/2})}},listeners:function(a,h,e){d.each(d("."+a.teamClass+" > h3"),function(){var b="."+d(this).parent().attr("class").split(" ")[1]; b!==void 0&&d(b).hover(function(){d(b).addClass(a.currentClass)},function(){d(b).removeClass(a.currentClass)})});g.build.canvas.resize(a);g.build.canvas.draw(a,h,e)}};if(t[k])return t[k].apply(this,Array.prototype.slice.call(arguments,1));else if(typeof k==="object"||!k)return t.init.apply(this,arguments);else d.error('Method "'+k+'" does not exist in gracket!')}})(jQuery);$("[data-gracket]").gracket();