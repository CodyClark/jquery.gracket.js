// Bracket Plugin | Gracket (jquery.gracket.js)
// Erik Zettersten
// Version 1.8

(function(e){e.fn.gracket=function(k){e.fn.gracket.defaults={gameClass:"g_game",roundClass:"g_round",teamClass:"g_team",winnerClass:"g_winner",spacerClass:"g_spacer",currentClass:"g_current",canvasId:"g_canvas",canvasClass:"g_canvas",canvasLineColor:"white",canvasLineCap:"round",cornerRadius:3,canvasLineWidth:2,canvasLineGap:3,src:null};var h=this,n=JSON.parse(h.data("gracket"))||JSON.parse(this.gracket.defaults.src),q,t,u;e.fn.gracket.settings={};var p={init:function(a){this.gracket.settings=e.extend({}, this.gracket.defaults,a);h.append("<canvas id='"+this.gracket.settings.canvasId+'\' style="position:absolute;top:0;left:0;" />');t=n.length;for(a=0;a<t;a++){var m=g.build.round(this.gracket.settings);h.append(m);u=n[a].length;for(var c=0;c<u;c++){var b=g.build.game(this.gracket.settings),j=h.find("."+this.gracket.settings.gameClass).outerHeight(!0),j=g.build.spacer(this.gracket.settings,j,a,a!==0&&c===0?!0:!1);c%1==0&&a!==0&&m.append(j);m.append(b);q=n[a][c].length;for(j=0;j<q;j++){var v=g.build.team(n[a][c][j], this.gracket.settings);b.append(v);q===1&&(b.prev().remove(),g.align.winner(b,this.gracket.settings,b.parent().prev().children().eq(0).height()),g.listeners(this.gracket.settings,n,b.parent().prev().children().eq(1)))}}}}},g={build:{team:function(a,m){return team=e("<div />",{html:"<h3><span>"+(a.seed||0)+"</span>"+a.name+"</h3>","class":m.teamClass+" "+(a.id||"id_null")})},game:function(a){return game=e("<div />",{"class":a.gameClass})},round:function(a){return round=e("<div />",{"class":a.roundClass})}, spacer:function(a,m,c,b){return spacer=e("<div />",{"class":a.spacerClass}).css({height:b?(Math.pow(2,c)-1)*(m/2):(Math.pow(2,c)-1)*m})},canvas:{resize:function(a){a=document.getElementById(a.canvasId);a.height=h.innerHeight();a.width=h.innerWidth();e(a).css({height:h.innerHeight(),width:h.innerWidth(),zIndex:1,pointerEvents:"none"})},draw:function(a,e,c){var b=document.getElementById(a.canvasId).getContext("2d"),j=c.outerWidth(!0),g=c.outerHeight(!0),k=parseInt(h.css("paddingLeft"))||0,n=parseInt(h.css("paddingTop"))|| 0;parseInt(c.css("marginBottom"));var k=j+k,o=parseInt(h.find("> div").css("marginRight"))||0,d=a.cornerRadius,r=a.canvasLineGap,q=c.height()-2*c.find("> div").eq(1).height();_playerHt=c.find("> div").eq(1).height();d>g/3&&(d=g/3);d>o/2&&(d=o/2-2);d<=0&&(d=1);r>o/3&&(r=o/3);b.strokeStyle=a.canvasLineColor;b.lineCap=a.canvasLineCap;b.lineWidth=a.canvasLineWidth;b.beginPath();for(var a=Math.pow(2,e.length-2),c=0,s,p=0.5;a>=1;){for(s=0;s<a;s++){a==1&&(p=1);var f=k+c*j+c*o,i=p*o,l=((Math.pow(2,c-1)-0.5)* (c&&1)+s*Math.pow(2,c))*g+n+_playerHt+q/2;b.moveTo(f+r,l);a>1?b.lineTo(f+i-d,l):b.lineTo(f+i-r,l);a<Math.pow(2,e.length-2)&&(b.moveTo(f-j-r,l),b.lineTo(f-j-0.5*o,l));a>1&&s%2==0&&(b.moveTo(f+i,l+d),b.lineTo(f+i,l+Math.pow(2,c)*g-d),f=f+i-d,i=l+d,b.moveTo(f,i-d),b.arcTo(f+d,i-d,f+d,i,d),i=l+Math.pow(2,c)*g-d,b.moveTo(f+d,i-d),b.arcTo(f+d,i+d,f,i+d,d))}c++;a/=2}b.stroke()}}},align:{winner:function(a,e,c){return a.addClass(e.winnerClass).css({"margin-top":c+a.height()/2})}},listeners:function(a,h,c){e.each(e("."+ a.teamClass+" > h3"),function(){var b="."+e(this).parent().attr("class").split(" ")[1];b!==void 0&&e(b).hover(function(){e(b).addClass(a.currentClass)},function(){e(b).removeClass(a.currentClass)})});g.build.canvas.resize(a);g.build.canvas.draw(a,h,c)}};if(p[k])return p[k].apply(this,Array.prototype.slice.call(arguments,1));else if(typeof k==="object"||!k)return p.init.apply(this,arguments);else e.error('Method "'+k+'" does not exist in gracket!')}})(jQuery);